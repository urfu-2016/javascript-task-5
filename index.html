<html>
<head>
    <script>
    'use strict';

    /**
     * Сделано задание на звездочку
     * Реализованы методы several и through
     */
    getEmitter.isStar = true;
    var exports = getEmitter;

    function EventTarget(target) {
        target.callbacks = target.callbacks || {};
        target.on = function(event, fn) {
            target.callbacks[event] = target.callbacks[event] || [];
            target.callbacks[event].push(fn);
        };
        target.off = function (event) {
            Object.keys(target.callbacks).forEach(function (subscribedEvent) {
                if (subscribedEvent.indexOf(event) === 0) {
                    target.callbacks[subscribedEvent] = [];
                }
            });
        };
        target.dispatch = function(event) {
            //target.callbacks[event].reverse();
            target.callbacks[event].forEach(function (fn) {
                fn.apply(target, arguments);
            });
            //target.callbacks[event].reverse();
        };

        return target;
    }
    function getAllNamespacedEvents(event) {
        var namespaces = event.split('.');
        var events = [];
        namespaces.forEach(function () {
            events.push(event);
            var lastDotIdx = event.lastIndexOf('.');
            if (lastDotIdx === -1) {
                return;
            }
            event = event.slice(0, lastDotIdx);
        });

        return events;
    }

    /**
     * Возвращает новый emitter
     * @returns {Object}
     */
    function getEmitter() {
        return {
            observers: {},

            /**
             * Подписаться на событие
             * @param {String} event
             * @param {Object} context
             * @param {Function} handler
             */
            on: function (event, context, handler) {
                console.info(event, context, handler);
                context = new EventTarget(context);
                context.on(event, handler);
                this.observers[event] = this.observers[event] || [];
                if (this.observers[event].indexOf(context) === -1) {
                    this.observers[event].push(context);
                }

                return this;
            },
            

            /**
             * Отписаться от события
             * @param {String} event
             * @param {Object} context
             */
            off: function (event, context) {
                console.info(event, context);
                context = new EventTarget(context);
                context.off(event);
                var self = this;
                Object.keys(this.observers).forEach(function (subscribedEvent) {
                    var targetIdx = self.observers[subscribedEvent].indexOf(context);
                    if (subscribedEvent.indexOf(event) === 0 && subscribedEvent) {
                        self.observers[subscribedEvent].splice(targetIdx, 1);
                    }
                });

                return this;
            },
            

            /**
             * Уведомить о событии
             * @param {String} event
             */
            emit: function (event) {
                console.info(event);
                var allEvents = getAllNamespacedEvents(event);
                var self = this;
                allEvents.forEach(function (event) {
                    if (typeof self.observers[event] === 'undefined') {
                        return;
                    }
                    //self.observers[event].reverse();
                    self.observers[event].forEach(function (target) {
                        target.dispatch(event);
                    });
                    //self.observers[event].reverse();
                });
                return this;
            },

            /**
             * Подписаться на событие с ограничением по количеству полученных уведомлений
             * @star
             * @param {String} event
             * @param {Object} context
             * @param {Function} handler
             * @param {Number} times – сколько раз получить уведомление
             */
            several: function (event, context, handler, times) {
                console.info(event, context, handler, times);
            },

            /**
             * Подписаться на событие с ограничением по частоте получения уведомлений
             * @star
             * @param {String} event
             * @param {Object} context
             * @param {Function} handler
             * @param {Number} frequency – как часто уведомлять
             */
            through: function (event, context, handler, frequency) {
                console.info(event, context, handler, frequency);
            }
        };
    }
    
    </script>
</head>
<body>
</body>
</html>